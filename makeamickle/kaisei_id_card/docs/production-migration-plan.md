# 本番環境移行計画

## 環境構築スケジュール

### Phase別環境計画

| Phase | 環境 | Firebaseプロジェクト | 目的 |
|-------|------|---------------------|------|
| **Phase 0-1** | ローカルエミュレータ | なし | 基盤構築・基本実装 |
| **Phase 2後半** | 開発環境 | kaisei-id-card-dev | チーム開発・実機テスト |
| **Phase 5開始時** | ステージング環境 | kaisei-id-card-staging | 本番相当テスト |
| **Phase 7前半** | 本番環境 | kaisei-id-card-prod | 本番準備 |
| **Phase 7完了後** | パイロット運用 | kaisei-id-card-prod | 限定公開（50名） |
| **パイロット成功後** | 本番全面稼働 | kaisei-id-card-prod | 全ユーザー（750名+卒業生） |

## 各環境の詳細

### 1. 開発環境（Phase 2後半）

#### 構築タイミング
- Phase 2の生徒証コア機能実装中盤
- オフライン機能の基本実装が完了した時点

#### 構築理由
- チーム開発の開始
- 実機デバイステスト（iOS/Android）
- Firebase固有機能のテスト（FCM等）

#### 設定内容
```bash
# プロジェクト作成
firebase projects:create kaisei-id-card-dev --display-name "開成IDカード開発"

# 基本設定
- リージョン: asia-northeast1
- 認証: メール/パスワードのみ
- Firestore: テストモード（開発用セキュリティルール）
- Storage: 10GB上限
- Functions: Node.js 18、最大10インスタンス
- 料金アラート: 月額1,000円
```

#### コスト
- 月額: 0〜1,000円（Firebase無料枠を最大活用）

### 2. ステージング環境（Phase 5開始時）

#### 構築タイミング
- Phase 5の通知機能実装開始前
- Phase 4の年次処理実装完了後

#### 構築理由
- 本番相当のテスト環境
- 750名規模の負荷テスト
- セキュリティ監査の実施
- 卒業生機能のテスト

#### 設定内容
```bash
# プロジェクト作成
firebase projects:create kaisei-id-card-staging --display-name "開成IDカードステージング"

# 本番相当設定
- リージョン: asia-northeast1
- 認証: 本番セキュリティルール適用
- Firestore: 本番ルール、複合インデックス設定
- Storage: 50GB、画像最適化設定
- Functions: 本番設定、最大50インスタンス
- Monitoring: Cloud Monitoring有効
- Backup: 週次バックアップ
```

#### テストデータ
- 本番相当の750名分のテストデータ
- 個人情報はマスキング処理
- 卒業生データ1,000名分

#### コスト
- 月額: 3,000〜5,000円

### 3. 本番環境（Phase 7前半）

#### 構築タイミング
- Phase 7のテスト・移行準備フェーズ前半
- 全機能の実装完了後

#### 設定内容
```bash
# プロジェクト作成
firebase projects:create kaisei-id-card-prod --display-name "開成IDカード本番"

# セキュリティ強化設定
- リージョン: asia-northeast1
- 認証: 厳格なセキュリティルール、レート制限
- Firestore: 本番セキュリティルール、自動バックアップ
- Storage: 100GB、CDN有効、画像自動リサイズ
- Functions: 最大100インスタンス、エラー監視
- Backup: 日次自動バックアップ
- Monitoring: 完全監視、アラート設定
- Security: Cloud Armor、DDoS対策
```

## 本番移行プロセス

### Phase 7完了後: パイロット運用

#### 対象（限定50名）
- 情報システム委員会の生徒（10名）
- 各学年代表生徒（6名）
- 協力的な教職員（20名）
- IT担当者・管理者（14名）

#### 期間
- 1週間（月曜開始、金曜評価）

#### 成功基準
- 重大な不具合: 0件
- 軽微な不具合: 5件以下
- パフォーマンス基準達成（応答200ms以下）
- ユーザー満足度: 80%以上

#### 切り戻し条件
- データ損失の発生
- 30分以上のシステム停止
- セキュリティインシデント
- 半数以上のユーザーから使用不可報告

### パイロット成功後: 段階的全面展開

#### 展開スケジュール

| 日程 | 対象 | 人数 | 確認事項 |
|------|------|------|----------|
| Day 1（月） | 中学1年生 | 125名 | 基本機能、アクティベーション |
| Day 2（火） | 中学2年生 | 125名 | 負荷状況、同時アクセス |
| Day 3（水） | 中学3年生 | 125名 | 安定性、エラー率 |
| Day 4（木） | 高校1年生 | 125名 | スケーラビリティ |
| Day 5（金） | 高校2年生 | 125名 | 全体負荷 |
| Day 6（月） | 高校3年生 | 125名 | ピーク性能 |
| Day 7（火） | 教職員 | 50名 | 管理機能 |
| Day 8以降 | 卒業生（希望者） | 順次 | 通知機能、プロフィール更新 |

#### 各日のサポート体制
- 8:00-9:00: 重点サポート（登校時）
- 12:00-13:00: 通常サポート（昼休み）
- 15:00-16:00: 重点サポート（放課後）
- オンコール: 2名体制（7:00-22:00）

## リスク管理

### 主要リスクと対策

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| データ移行失敗 | 高 | 低 | 3回のリハーサル、自動化スクリプト、差分バックアップ |
| 性能劣化 | 高 | 中 | 段階展開、リアルタイム監視、オートスケーリング |
| セキュリティ侵害 | 高 | 低 | 事前監査、WAF導入、侵入検知 |
| ユーザー混乱 | 中 | 中 | 事前説明会、動画マニュアル、FAQ準備 |
| 旧システム停止 | 中 | 低 | 1ヶ月並行運用、段階的切り替え |

### 緊急時対応計画

#### 即時切り戻し手順（所要時間: 20分）
1. 本番環境を読み取り専用モードに変更（1分）
2. エラー画面を表示（2分）
3. ステージング環境を臨時本番に切り替え（5分）
4. DNSを旧システムに切り替え（10分）
5. ユーザーへの緊急通知（2分）

#### エスカレーションフロー
1. L1サポート: 5分以内に初期対応
2. L2エンジニア: 15分以内に技術対応
3. L3責任者: 30分以内に判断
4. 経営層: 1時間以内に最終決定

## コスト計画

### Phase別月額コスト

| Phase | 環境 | 月額費用 | 累計費用 |
|-------|------|----------|----------|
| Phase 0-1 | エミュレータ | 0円 | 0円 |
| Phase 2-4 | 開発 | 1,000円 | 3,000円 |
| Phase 5-6 | 開発+ステージング | 6,000円 | 12,000円 |
| Phase 7 | 開発+ステージング+本番 | 16,000円 | 16,000円 |
| 運用1年目 | 本番+開発 | 11,000円 | 132,000円/年 |

### 本番環境コスト内訳（月額）

| サービス | 使用量 | 料金 |
|----------|--------|------|
| Firestore | 読み: 100万回/日、書き: 10万回/日、10GB | 3,000円 |
| Storage | 50GB（生徒写真） | 1,000円 |
| Functions | 200万実行/月 | 2,000円 |
| Authentication | 1万MAU（750名+卒業生） | 1,000円 |
| Hosting | 10GB転送/月 | 1,000円 |
| Backup/Monitoring | 日次バックアップ、監視 | 2,000円 |
| **合計** | - | **10,000円** |

## チェックリスト

### Phase 2後半: 開発環境構築前
- [ ] エミュレータでの基本機能動作確認
- [ ] Firebaseプロジェクト名の最終決定
- [ ] 課金アカウントの準備
- [ ] チームメンバーのアクセス権限設計

### Phase 5: ステージング環境構築前
- [ ] 開発環境での全機能テスト完了
- [ ] テストデータの準備
- [ ] 負荷テストシナリオ作成
- [ ] セキュリティ監査準備

### Phase 7: 本番環境構築前
- [ ] ステージング環境での受入テスト完了
- [ ] データ移行手順書作成
- [ ] 運用マニュアル完成
- [ ] サポート体制確立

### パイロット運用開始前
- [ ] 本番環境の全機能テスト
- [ ] パイロットユーザーへの説明完了
- [ ] 緊急連絡網の確立
- [ ] 切り戻し手順の確認

### 全面展開前
- [ ] パイロット運用での問題解決
- [ ] 全ユーザーへの案内完了
- [ ] ヘルプデスク準備完了
- [ ] 旧システム並行運用準備

## 成功指標

### 技術指標
- 可用性: 99.5%以上（月間停止時間: 3.6時間以内）
- 応答時間: 平均200ms以下、P95 500ms以下
- エラー率: 0.1%以下
- 同時接続: 1,000ユーザー対応

### ビジネス指標
- アクティブ率: 90%以上（1ヶ月後）
- ユーザー満足度: 80%以上
- サポート問い合わせ: 50件/日以下（安定期）
- コスト: 年間15万円以内

## 連絡先

### 本番移行時の体制
- **総責任者**: プロジェクトマネージャー
- **技術責任者**: テックリード
- **インフラ責任者**: SRE担当
- **品質責任者**: QAリード
- **ユーザー対応責任者**: サポートマネージャー

---

最終更新: 2024-08-13
次回レビュー: Phase 2完了時